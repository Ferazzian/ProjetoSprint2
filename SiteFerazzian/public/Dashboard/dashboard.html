<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="main.js" defer></script>
  <link rel="stylesheet" href="styleDashboard.css">
  <link rel="icon" href="../assets/logo.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.11.0/dist/sweetalert2.all.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.11.0/dist/sweetalert2.min.css" rel="stylesheet">
  <title>Dashboard | Ferazzian</title>
</head>

<body>
  <div class="tela_hectare" id="tela_hectare">
    <a href="../cadastro.html" id="botao_Cadastrar" style="display: none;">
      <button class="btnCadastro" >cadastrar Funcionario</button>
    </a>
    <br>
    <div class="header">
      <h1>SELECIONE O HECTARE QUE DESEJA MONITORAR</h1>
      <div class="linha_header"></div>
    </div>
    <div class="container_center" id="container_hectare">
      <div class="caixa">
        <div class="hectare" id="hectare1" onclick="hectare1()">
          <h3>Hectare: 1</h3>
          <h3 id="hectare1_h3"></h3>
        </div>

        <div class="hectare" id="hectare2" onclick="hectare2()">
          <h3>Hectare: 2</h3>
          <h3 id="hectare2_h3"></h3>
        </div>

        <div class="hectare" id="hectare3" onclick="hectare3()">
          <h3>Hectare: 3</h3>
          <h3 id="hectare3_h3"></h3>
        </div>

        <div class="hectare" id="hectare2" onclick="hectare2()">
          <h3>Hectare: 4</h3>
          <h3 id="hectare4_h3"></h3>
        </div>

        <div class="hectare" id="hectare2" onclick="hectare2()">
          <h3>Hectare: 5</h3>
          <h3 id="hectare5_h3"></h3>
        </div>

        <div class="hectare" id="hectare2" onclick="hectare2()">
          <h3>Hectare: 6</h3>
          <h3 id="hectare6_h3"></h3>
        </div>
      </div>
    </div>
    <div class="container_alerta" id="container_alerta">
      <div class="Alerta" id="alerta">
        <center>
          <h3>O monitoramento da FERAZZIAN detectou hectares com risco de desenvolvimento da Ferrugem Asiática.</h3>
          <h3 class="h3">Clique para continuar:</h3>
          <button class="button_continuar" onclick="informado()">Continuar</button>
        </center>
      </div>
    </div>
  </div>

  <div class="tela_grafico" id="tela_grafico">
    <div class="container_button_voltar">
      <button class="button" onclick="Voltar()">Voltar</button>
    </div>

    <div class="container">
      <div class="legInf">
        <section class="informacao">
          <div class="conteudoInf">
            <span id="nomeFazenda"></span>
            <span id="hectare_numero"></span>
            <span id="tipo_soja"></span>
          </div>
        </section>

        <section class="legenda">
          <div class="conteudoLeg">
            <!-- <h2>Legenda</h2> -->
<br><br><br>
            <div id="conteudoLeg">
              <div class="grupoDados">
                <span class="dados">- Se a temperatura e a umidade estiverem FORA das zonas <span style="color: red">vermelhas</span>, sua plantação está <span style="color: lawngreen">segura</span>;
                <br><br><br>
                - Se a temperatura ou a umidade estiverem DENTRO das zonas <span style="color: red">vermelhas</span>, sua plantação está <span style="color: orange">segura</span>;
                <br><br><br>
                - Se a temperatura e a umidade estiverem DENTRO das zonas <span style="color: red">vermelhas</span>, sua plantação está <span style="color: red">segura</span>.
              </span>
                
              </div>
            </div>
          </div>
        </section>
      </div>

      <section class="dashboard" id="dashboard">
        <div class="alinharGraficoKpi">
          <div class="alinharKpi">
            <div>
              <div id="tempKpi" class="KPI">
                <h2>Temperatura</h2><span id="temp"></span>
              </div>
              <div id="riscoKpi" class="KPI">
                <h2>Risco</h2><span id="risco"></span>
              </div>
              <div id="umidKpi" class="KPI">
                <h2>Umidade</h2><span id="umid"></span>
              </div>
            </div>
          </div>
          <div class="container_grafico">
            <div class="grafico" id="div1T">
              <canvas id="myChartCanvasTemp" style="height: 230px;"></canvas>
            </div>

            <div class="grafico" id="div1U">
              <canvas id="myChartCanvasUmid" style="height: 230px;"></canvas>
            </div>
          </div>
        </div>
    </div>
    </section>
  </div>
</body>

</html>


<script>
  obterDadosMacro();

  if (sessionStorage.TP_USUARIO == 'Administrador') {
    botao_Cadastrar.style.display = 'block'
  }

  function informado() {
    container_alerta.style.display = `none`;
    container_hectare.style.display = `flex`;
  }

  var idSensor;

  function hectare1() {
    idSensor = 1;
    tela_hectare.style.display = `none`;
    tela_grafico.style.display = `unset`;
    obterDadosGrafico();
  }

  function hectare2() {
    idSensor = 2;
    tela_hectare.style.display = `none`;
    tela_grafico.style.display = `unset`;
    obterDadosGrafico();
  }

  function hectare3() {
    idSensor = 3;
    tela_hectare.style.display = `none`;
    tela_grafico.style.display = `unset`;
    obterDadosGrafico();
  }

  function Voltar() {
    tela_hectare.style.display = `unset`;
    tela_grafico.style.display = `none`;
  }

var cont;
  function obterDadosMacro() {
    for (cont = 1; cont < 4; cont++) {
      fetch(`/medida/buscarPorHectare/${cont}`)
        .then(function (resposta) {
          if (resposta.ok) {
            resposta.json().then(function (dados1) {
              // console.log("Dados recebidos: ", JSON.stringify(dados));

              // verificacaoMacro(dados1, cont);
              var temperatura_atual = dados1.sensorTemp;
              var umidade_atual = dados1.sensorUmid;
              var temperatura_Maxima = dados1.tempMaxima;
              var temperatura_Minima = dados1.tempMinima;
              var umidade_Minima = dados1.umidMinima;
              console.log('Estou na verificação Macro: ' + dados1);

              var resumo = document.getElementById(`hectare${cont}`);
              var caixa = document.getElementById(`hectare${cont}_h3`);

              if (temperatura_atual >= temperatura_Minima && temperatura_atual <= temperatura_Maxima && umidade_atual >= umidade_Minima) {
                resumo.innerHTML = `<b>Risco: ALTO</b>`;
                caixa.style = `background-color: red`;

                //   Swal.fire({
                //   position: "bottom-end",
                //   icon: "warning",
                //   title: `HECTARES ${dados.fkSensorDados} COM RISCO`,
                //   background: "#1D1D1D",
                //   color: "#FFF",
                //   showConfirmButton: false,
                // });
              }

              if (temperatura_atual >= temperatura_Minima && temperatura_atual <= temperatura_Maxima && umidade_atual < umidade_Minima || ((temperatura_atual < temperatura_Minima || temperatura_atual > temperatura_Maxima) && umidade_atual >= umidade_Minima)) {
                resumo.innerHTML = `<b>Risco: Médio</b>`;
                caixa.style = `background-color: orange`;
                console.log('Esta medio');
                //   Swal.fire({
                //   position: "bottom-end",
                //   icon: "warning",
                //   title: `HECTARES ${dados.fkSensorDados} COM RISCO`,
                //   background: "#1D1D1D",
                //   color: "#FFF",
                //   showConfirmButton: false,
                // });
              }

              if ((temperatura_atual < temperatura_Minima || temperatura_atual > temperatura_Maxima) && umidade_atual < umidade_Minima) {
                resumo.innerHTML = `<b>Risco: Baixo</b>`;
                caixa.style = `background-color: #395D05`;
                console.log('Esta Baixo');
              }
            });
          } else {
            console.error('Nenhum dado encontrado no banco ou erro na API');
          }
        })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
    }
  }



  function obterDadosGrafico() {
    fetch(`/medida/buscarUltimasMedidas/${idSensor}`)
      .then(function (resposta) {
        if (resposta.ok) {
          resposta.json().then(function (dados) {
            // console.log("Dados recebidos: ", JSON.stringify(dados));

            verificacao(dados);
            plotarGraficoTemperatura(dados);
            plotarGraficoUmidade(dados);
          });
        } else {
          console.error('Nenhum dado encontrado no banco ou erro na API');
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });
  }


  function plotarGraficoTemperatura(dados) {
    const ctx = document.getElementById('myChartCanvasTemp');

    if (Chart.getChart(ctx)) {
      Chart.getChart(ctx).destroy();
    }

    console.log("Dados recebidos no plotar: ", JSON.stringify(dados));
    console.log('Iniciando plotagem do gráfico...');

    // Criando estrutura para plotar gráfico - labels e data
    let labels = [];

    Chart.defaults.color = '#ffffff';
    Chart.defaults.font.size = 15;

    let chartData = {
      labels: labels,
      datasets: [{
        label: 'Temperatura',
        data: [],
        borderColor: '#B0CDDA',
        borderWidth: 2
      },
      {
        label: 'Temperatura Mínima',
        data: [],
        borderColor: '#EE675C',
        borderWidth: 2
      },
      {
        label: 'Temperatura Máxima',
        data: [],
        borderColor: '#EE675C',
        borderWidth: 2
      },

      ]
    };

    console.log('----------------------------------------------');
    console.log('Estes dados foram recebidos pela função "obterDadosGrafico" e passados para "plotarGraficoTemperatura":');
    console.log(dados);

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'line',
      data: chartData,
      options: {
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 5
            }
          }
        }
      }
    };

    // Adicionando gráfico criado em div na tela

    for (i = 0; i < dados.length; i++) {
      var registro = dados[i];
      labels.push(registro.horaColeta);
      chartData.datasets[0].data.push(registro.sensorTemp);
      chartData.datasets[1].data.push(registro.tempMaxima);
      chartData.datasets[2].data.push(registro.tempMinima);
    }
    let myChart = new Chart(
      document.getElementById('myChartCanvasTemp'),
      config
    );
  }

  function plotarGraficoUmidade(dados) {
    const ctx = document.getElementById('myChartCanvasUmid');

    if (Chart.getChart(ctx)) {
      Chart.getChart(ctx).destroy();
    }

    console.log("Dados recebidos no plotar: ", JSON.stringify(dados));
    console.log('Iniciando plotagem do gráfico...');

    // Criando estrutura para plotar gráfico - labels e data
    let labels = [];

    Chart.defaults.color = '#ffffff';
    // Chart.defaults.font.size = 15;

    let chartData = {
      labels: labels,
      datasets: [{
        label: 'Umidade',
        data: [],
        borderColor: '#B0CDDA',
        borderWidth: 2
      },
      {
        label: 'Umidade Mínima',
        data: [],
        borderColor: '#EE675C',
        borderWidth: 2
      }]
    };

    console.log('----------------------------------------------');
    console.log('Estes dados foram recebidos pela função "obterDadosGrafico" e passados para "plotarGraficoUmidade":');
    console.log(dados);

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: 'line',
      data: chartData,
      options: {
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 10
            }
          }
        }
      }
    };

    // Adicionando gráfico criado em div na tela
    for (i = 0; i < dados.length; i++) {
      var registro = dados[i];
      labels.push(registro.horaColeta);
      chartData.datasets[0].data.push(registro.sensorUmid);
      chartData.datasets[1].data.push(registro.umidMinima);
    }
    let myChart = new Chart(
      document.getElementById('myChartCanvasUmid'),
      config
    );
  }

  function verificacao(dados) {
    var tamanho = dados.length;
    var registro = dados[tamanho - 1];
    var temperatura_atual = registro.sensorTemp;
    var umidade_atual = registro.sensorUmid;
    var temperatura_Maxima = registro.tempMaxima;
    var temperatura_Minima = registro.tempMinima;
    var umidade_Minima = registro.umidMinima;
    console.log('Estou na verificação: ' + dados);

    if (temperatura_atual >= temperatura_Minima && temperatura_atual <= temperatura_Maxima && umidade_atual >= umidade_Minima) {
      risco.innerHTML = `<b>ALTO</b>`;
      riscoKpi.style = `background-color: red`;
      temp.innerHTML = temperatura_atual + '°C';
      tempKpi.style = `background-color: red`;
      umid.innerHTML = umidade_atual + '%';
      umidKpi.style = `background-color: red`;
    }

    if (temperatura_atual >= temperatura_Minima && temperatura_atual <= temperatura_Maxima && umidade_atual < umidade_Minima) {
      risco.innerHTML = `<b>Médio</b>`;
      riscoKpi.style = `background-color: orange`;
      temp.innerHTML = temperatura_atual + '°C';
      tempKpi.style = `background-color: red`;
      umid.innerHTML = umidade_atual + '%';
      umidKpi.style = `background-color: #395D05`;
    }

    if ((temperatura_atual < temperatura_Minima || temperatura_atual > temperatura_Maxima) && umidade_atual >= umidade_Minima) {
      risco.innerHTML = `<b>Médio</b>`;
      riscoKpi.style = `background-color: orange`;
      temp.innerHTML = temperatura_atual + '°C';
      tempKpi.style = `background-color: #395D05`;
      umid.innerHTML = umidade_atual + '%';
      umidKpi.style = `background-color: red`;
    }

    if ((temperatura_atual < temperatura_Minima || temperatura_atual > temperatura_Maxima) && umidade_atual < umidade_Minima) {
      risco.innerHTML = `<b>Baixo</b>`;
      riscoKpi.style = `background-color: #395D05`;
      temp.innerHTML = temperatura_atual + '°C';
      tempKpi.style = `background-color: #395D05`;
      umid.innerHTML = umidade_atual + '%';
      umidKpi.style = `background-color: #395D05`;
    }
  }

  // function verificacaoMacro(dados1, i) {

  // }



  setInterval(() => {
    obterDadosMacro(),
      obterDadosGrafico()
  }, 20000);
</script>